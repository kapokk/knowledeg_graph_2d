<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph</title>
    <link rel="stylesheet" href="/static/css/litegraph.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="/static/js/litegraph.js"></script>
    <script type="module">
      import ApiClient from '/static/js/api/ApiClient.js';
      import WebSocketClient from '/static/js/api/WebSocketClient.js';
      import GraphManager from '/static/js/core/GraphManager.js';
      import NodeManager from '/static/js/core/NodeManager.js';
      
      class Application {
        constructor() {
          // 初始化 API 客户端
          this.apiClient = new ApiClient();
          
          // 初始化 WebSocket 客户端
          this.wsClient = new WebSocketClient();
          
          // 初始化图管理器
          this.graphManager = new GraphManager(this.apiClient, this.wsClient);
          
          // 初始化节点管理器
          this.nodeManager = new NodeManager(this.apiClient, this.wsClient);
        }

        async initialize() {
          try {
            // 初始化 WebSocket 连接
            this.wsClient.connect();
            
            // 初始化图实例
            await this.graphManager.initialize();
            
            // 加载初始数据
            await this.nodeManager.loadInitialData();
            
            // 设置事件监听
            this.setupEventListeners();
            
            console.log('Application initialized successfully');
          } catch (error) {
            console.error('Failed to initialize application:', error);
          }
        }

        setupEventListeners() {
          // WebSocket 事件监听
          this.wsClient.on('node_created', (nodeData) => {
            this.nodeManager.handleNodeCreated(nodeData);
          });

          this.wsClient.on('node_updated', (nodeData) => {
            this.nodeManager.handleNodeUpdated(nodeData);
          });

          this.wsClient.on('node_deleted', (nodeData) => {
            this.nodeManager.handleNodeDeleted(nodeData);
          });

          // 窗口大小变化事件
          window.addEventListener('resize', () => {
            this.graphManager.handleWindowResize();
          });
        }
      }

      // 启动应用
      document.addEventListener('DOMContentLoaded', () => {
        const app = new Application();
        app.initialize();
      });
    </script>
    <script>
        // Add this to help debug Socket.IO connection issues
        localStorage.debug = 'socket.io-client:socket';
    </script>
</head>
<body style='width:100%; height:100%'>
    <div class="graph-wrapper">
        <canvas id="graph-container"></canvas>
    </div>
</body>
</html>
